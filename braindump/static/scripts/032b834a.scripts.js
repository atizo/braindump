"use strict";angular.module("braind",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","restangular","monospaced.elastic","angularFileUpload","bdDirectives","bdFilters"]).config(["$routeProvider","$locationProvider","$httpProvider","$provide","bdClipProvider",function(a,b,c,d,e){b.html5Mode(!0),c.defaults.xsrfHeaderName="X-CSRFToken",c.defaults.xsrfCookieName="csrftoken",a.when("/",{templateUrl:"/static/views/main.html",controller:"StartCtrl"}).when("/glitch",{templateUrl:"/static/views/glitch.html",controller:"GlitchCtrl"}).when("/:brainstorming/invite",{templateUrl:"/static/views/invite.html",controller:"InviteCtrl"}).when("/:brainstorming/edit",{templateUrl:"/static/views/edit.html",controller:"EditCtrl"}).when("/:brainstorming/notification",{templateUrl:"/static/views/notification.html",controller:"NotificationCtrl"}).when("/:brainstorming",{templateUrl:"/static/views/brainstorming.html",controller:"BrainstormingCtrl"}).otherwise({redirectTo:"/"}),e.setPath("/static/bower_components/zeroclipboard/ZeroClipboard.swf"),d.constant("brainstormingStore",angular.copy(window.brainstormingStore)),d.constant("ideaStore",angular.copy(window.ideaStore)),d.constant("recentBrainstormings",angular.copy(window.recentBrainstormings)),d.constant("errorMsg",angular.copy(window.errorMsg)),d.constant("infoMsg",angular.copy(window.infoMsg))}]).run(["$rootScope","$location","errorMsg",function(a,b,c){c&&c.length>0&&b.path("/glitch").replace(),a.user={email:angular.copy(window.email),name:angular.copy(window.name)}}]),angular.module("braind").controller("StartCtrl",["$scope","$rootScope","$location","brainstormingService",function(a,b,c,d){b.showDeco=!1,a.create=function(){a.user.email=a.formData.creatorEmail,a.loading=!0,d.post(a.formData).then(function(a){c.path("/"+a.id+"/invite")})["finally"](function(){a.loading=!1})},a.reset=function(){a.formData={question:"",creatorEmail:a.user.email,details:""}},a.showDeco=!0,d.getRecent().then(function(c){a.rb=c,b.showDeco=!c.length}),a.reset()}]),angular.module("braind").controller("InviteCtrl",["$scope","$rootScope","$location","$routeParams","brainstormingService",function(a,b,c,d,e){var f=e.get(d.brainstorming);f.then(function(b){a.bs=b,a.subject=window.encodeURIComponent(a.bs.question),a.body=window.encodeURIComponent('I would like to invite you to the brainstorming "'+a.bs.question+'"\n\nPlease follow the link in order to participate in the brainstorming:\n'+a.bs.url)},function(){c.path("/").replace()})}]),angular.module("braind").controller("BrainstormingCtrl",["$scope","$routeParams","$location","$rootScope","$upload","brainstormingService","bdDate",function(a,b,c,d,e,f,g){var h=b.brainstorming;a.file=null,f.get(h).then(function(b){b.createdFormatted=g.format(b.created),a.brainstorming=b},function(){c.path("/").replace()}),f.getIdeas(h).then(function(b){a.ideasRaw=b}),a.$watchCollection("ideasRaw",function(b){b=_.toArray(b),_.each(b,function(a){a.createdDate=a.created?new Date(a.created):0}),a.ideas=_.sortBy(b,function(a){return-a.createdDate})}),a.create=function(){a.loading=!0,f.postIdea(h,a.formData,a.file).then(function(){a.user.name=a.formData.creatorName,a.reset(),a.fullform=!1})["finally"](function(){a.loading=!1})},a.formCancel=function(){a.fullform=!1,a.reset()},a.openDetail=function(a){var b=angular.element(a.target).closest("div.bd-idea").attr("iid");f.getIdea(h,b).then(function(a){d.$broadcast("bd:mopen",a)})},a.toolBar=[{href:"/"+h+"/export","class":"icon-download",title:"Export",target:"_self"},{href:"/"+h+"/notification","class":"icon-star",title:"Notifcations"}],a.editLink="/"+h+"/edit",a.reset=function(){a.file=null,a.formData={image:"",title:"",text:"",creatorName:a.user.name}},a.reset()}]).controller("IdeaDetailCtrl",["$scope","$window","$rootScope","$timeout","brainstormingService",function(a,b,c,d,e){c.$on("bd:mopen",function(b,c){a.ideaDetail=c,a.editMode=!1}),a.close=function(){c.$broadcast("bd:mclose")},a.rate=function(){a.ideaDetail.canEdit||e.rateIdea(a.ideaDetail.brainstorming,a.ideaDetail.id)},a.deleteIdea=function(){b.confirm("Do you really want to delete this idea?")&&(e.deleteIdea(a.ideaDetail.brainstorming,a.ideaDetail.id),c.$broadcast("bd:mclose"))},a.startEdit=function(){var c=angular.element(b.document);a.formData=_.clone(a.ideaDetail),a.editMode=!0,a.img={imageFile:null},d(function(){a.formData.title?c.find(".modal form .title").focus():a.formData.text&&c.find(".modal form .text").focus()},0)},a.cancelEdit=function(){a.editMode=!1},a.saveEdit=function(){a.loading=!0,e.updateIdea(a.ideaDetail.brainstorming,a.ideaDetail.id,a.formData,a.img.imageFile).then(function(){a.user.name=a.formData.creatorName,a.editMode=!1,c.$broadcast("bd:updateLayout")})["finally"](function(){a.loading=!1})}}]),angular.module("braind").controller("NotificationCtrl",["$scope","$rootScope","$location","$routeParams","brainstormingService","messageService",function(a,b,c,d,e,f){var g=e.get(d.brainstorming),h=f.getMsg();a.nuser={email:""},g.then(function(b){a.bs=b,h.length>0?a.infoMsg=h:a.submit=function(){b.post("notification",a.nuser).then(function(b){a.status={email:a.nuser.email,action:b.status}})}},function(){c.path("/").replace()})}]),angular.module("braind").controller("EditCtrl",["$scope","$rootScope","$location","$routeParams","brainstormingService",function(a,b,c,d,e){var f=e.get(d.brainstorming);a.nuser={email:""},f.then(function(b){a.bs=b,b.canEdit?(a.formData={question:b.question,details:b.details},a.update=function(){e.update(b.id,a.formData).then(function(){c.path("/"+b.id)})}):a.submit=function(){b.post("edit",a.nuser).then(function(b){a.status={email:a.nuser.email,action:b.status}})}},function(){c.path("/").replace()})}]),angular.module("braind").controller("GlitchCtrl",["$scope","errorMsg",function(a,b){a.errorMsg=b}]),angular.module("braind").factory("brainstormingService",["Restangular","$q","$upload","brainstormingStore","ideaStore","recentBrainstormings",function(a,b,c,d,e,f){function g(a){return l+"/"+a+"/ideas"}function h(a){return f=_.without(f,a),f.unshift(a),f}function i(a,b){return _.has(e,a)||(e[a]={}),e[a][b.id]=b,b}function j(a,b){return _.has(e,a)||(e[a]={}),_.has(e[a],b.id)||(e[a][b.id]={}),_.merge(e[a][b.id],b),b}function k(a,b){_.has(e,a)&&delete e[a][b]}var l="api/brainstormings";_.forOwn(d,function(b,c){d[c]=a.restangularizeElement(null,b,l)}),_.forOwn(e,function(b,c){_.forOwn(b,function(b,d){e[c][d]=a.restangularizeElement(null,b,g(c))})});var m={};return m.get=function(c){return _.has(d,c)?(h(c),b.when(d[c])):a.one(l,c).get().then(function(a){return h(a.id),d[a.id]=a,a})},m.getRecent=function(){var a,c=10,d=[];return _(f).forEach(function(b){return a>c?!1:(d.push(m.get(b)),void(a+=1))}),b.all(d)},m.post=function(b){return a.all(l).post(b).then(function(a){return h(a.id),d[a.id]=a,a})},m.update=function(a,b){return m.get(a).then(function(a){return a.patch(b).then(function(a){return h(a.id),d[a.id]=a,a})})},m.getIdeas=function(c){return _.has(e,c)?b.when(e[c]):a.all(g(c)).getList().then(function(a){return e[c]={},_(a).forEach(function(a){e[c][a.id]=a}),e[c]})},m.getIdea=function(c,d){return _.has(e,c)&&_.has(e[c],d)?b.when(e[c][d]):a.one(g(c),d).get().then(function(a){return i(c,a)})},m.postIdea=function(b,d,e){return e?c.upload({url:g(b),data:d,file:e,fileFormDataName:"imagefile"}).then(function(c){return i(b,a.restangularizeElement(null,c.data,g(b)))}):a.all(g(b)).post(d).then(function(a){return i(b,a)})},m.updateIdea=function(b,d,e,f){return f?c.upload({url:g(b)+"/"+d,data:e,file:f,method:"PUT",fileFormDataName:"imagefile"}).then(function(c){return i(b,a.restangularizeElement(null,c.data,g(b)))}):a.one(g(b),d).patch(e).then(function(a){return j(b,a)})},m.deleteIdea=function(b,c){return a.one(g(b),c).remove().then(function(){return k(b,c)})},m.rateIdea=function(b,c){return _.has(e,b)&&_.has(e[b],c)&&(e[b][c].ratings||(e[b][c].ratings=0),e[b][c].rated?(e[b][c].rated=!1,e[b][c].ratings=e[b][c].ratings-=1):(e[b][c].rated=!0,e[b][c].ratings=e[b][c].ratings+=1)),a.one(g(b),c).post("rate").then(function(a){return j(b,a)})},m}]),angular.module("braind").factory("bdDate",["$window","$timeout","$exceptionHandler",function(a,b,c){var d={},e={},f=function(b){return Math.abs(a.moment().diff(a.moment(b),"minute"))>=1320},g=function(b){var c,d,e=new Date;return c=a.moment(b),d=f(b)?c.format(c.year()===e.getFullYear()?"D. MMM HH:mm":"D. MMM YYYY HH:mm"):c.fromNow()},h=function(){_.forOwn(e,function(a,b){var d,e;for(d=0,e=a.length;e>d;d++)if(a[d])try{a[d].apply(null,[g(b)])}catch(f){c(f)}else a.splice(d,1),d--,e--}),b(h,3e4)};return b(h,1e3),d.formatFromNow=function(a,b){if(angular.isDate(a)||(a=new Date(a)),b.apply(null,[g(a)]),f(a))return angular.noop;var c=e[a];return c||(e[a]=c=[]),c.push(b),function(){c[indexOf(c,b)]=null}},d.format=function(b,c){angular.isDate(b)||(b=new Date(b)),angular.isDefined(c)||(c="D. MMM YYYY HH:mm");var d=a.moment(b);return angular.isDefined(c)?d.format(c):d.toString()},d}]),angular.module("braind").factory("messageService",["infoMsg",function(a){var b=!0;return{getMsg:function(){return b?(b=!1,a):""}}}]),angular.module("braind").directive("bdFromNow",["$timeout","bdDate",function(a,b){return{restrict:"A",link:function(a,c,d){c.text("-");var e=b.formatFromNow(d.bdFromNow,function(a){c.text(a)});a.$on("destroy",e)}}}]),angular.module("bdDirectives",[]).provider("bdClip",function(){var a=this;return this.path="//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.2.3/ZeroClipboard.swf",{setPath:function(b){a.path=b},$get:function(){return{path:a.path}}}}).run(["$document","bdClip",function(a,b){ZeroClipboard.config({moviePath:b.path,trustedDomains:["*"],allowScriptAccess:"always",forceHandCursor:!0})}]).directive("bdClipCopy",[function(){return{scope:{bdClipCopy:"&",bdClipClick:"&"},restrict:"A",link:function(a,b,c){var d=new ZeroClipboard(b);d.on("load",function(d){var e=function(b){b.setText(a.$eval(a.bdClipCopy)),angular.isDefined(c.bdClipClick)&&a.$apply(a.bdClipClick)};d.on("mousedown",e),a.$on("$destroy",function(){d.off("mousedown",e),d.unclip(b)})})}}}]),angular.module("braind").directive("bdHeader",[function(){return{restrict:"EA",templateUrl:"/static/views/directives/bdheader.html",scope:{title:"@",action:"&",tools:"=",href:"@"}}}]),angular.module("braind").directive("bdIdea",["brainstormingService",function(a){return{restrict:"C",templateUrl:"/static/views/directives/bdidea.html",scope:{resource:"=",limit:"@",dynamicTextSize:"@",hideRatings:"@"},link:function(b){var c=null;b.dynamicTextSize?(c=b.$watchCollection("[resource.title, resource.text]",function(){var a=b.resource.title.length+b.resource.text.length;b.sizeClass=25>=a?"size-5":50>=a?"size-4":150>=a?"size-3":300>=a?"size-2":"size-1"}),b.$on("$destroy",c)):b.sizeClass="",b.rate=function(c){c.stopPropagation(),b.resource.canEdit||a.rateIdea(b.resource.brainstorming,b.resource.id)}}}}]),angular.module("braind").directive("bdUpload",["$parse",function(a){var b=function(a,b){var c=new Image;c.onload=function(){b(c)},c.src=a};return{restrict:"A",replace:!0,require:"ngModel",templateUrl:"/static/views/directives/image.html",priority:100,link:function(c,d,e,f){function g(){c.$apply(function(){f.$setViewValue(""),f.$setValidity("",!1),c.showPreview=!1,c.error="Invalid image (max. 3MB)"})}var h=d.find("input"),i=d.find("img"),j=new FileReader;f.$name="image",f.$render=function(){i.attr("src",f.$viewValue),c.showPreview=!!f.$viewValue},c.clear=function(){f.$setViewValue(""),c.showPreview=!1},h.bind("change",function(d){var h=d.target.files[0];j.onload=function(d){try{b(d.target.result,angular.noop),i.attr("src",d.target.result),c.$apply(function(){f.$setViewValue(d.target.result),a(e.file).assign(c,h),c.showPreview=!0,c.error=""})}catch(j){g()}},!h.type.match(/image.*/)||h.size>3145728?g():j.readAsDataURL(h)})}}}]),function(){angular.module("braind").controller("MasonryCtrl",["$rootScope","$scope","$element","$timeout","$window",function(a,b,c,d,e){var f={},g=!1,h=!1,i=this,j=null;this.minColumnWidth=220,this.gap=15,this.scheduleMasonry=function(){j&&d.cancel(j),j=d(i.runMasonry,30)},a.$on("bd:updateLayout",this.scheduleMasonry),this.runMasonry=function(){var a,b=Math.floor(c.width()/(i.minColumnWidth+i.gap))||1,e=Math.floor((c.width()-(b-1)*i.gap)/b),g=null,h=null;g=Array.apply(null,new Array(b)).map(Number.prototype.valueOf,0),a=_.toArray(f).sort(function(a,b){return a.scope().$index-b.scope().$index}),_.forOwn(a,function(a){a.css("width",e+"px")});var j=function(){_.forOwn(a,function(a){var b=a.outerHeight(!0);h=g.indexOf(Math.min.apply(Math,g)),a.css("transform","translate("+(h*e+h*i.gap)+"px, "+g[h]+"px)"),b>=417?a.addClass("limited"):a.removeClass("limited"),g[h]+=b+i.gap,a.addClass("show")}),c.css("height",Math.max.apply(Math,g)+"px")};d(j,1)},this.appendBrick=function(a,b){h||(void 0===f[b]&&(f[b]=a),i.scheduleMasonry(),g||(g=!0,angular.element(e).load(i.scheduleMasonry),e.fontcall=i.scheduleMasonry))},this.removeBrick=function(a){h||(delete f[a],i.scheduleMasonry())},this.destroy=function(){h=!0,angular.element(e).unbind("resize",i.scheduleMasonry),angular.element(e).unbind("load",i.scheduleMasonry),b.$emit("masonry.destroyed"),f=[]},angular.element(e).bind("resize",i.scheduleMasonry)}]).directive("masonry",function(){return{restrict:"AE",controller:"MasonryCtrl",link:{pre:function(a,b,c,d){d.minColumnWidth=parseInt(c.minColumnWidth,10),d.gap=parseInt(c.gap,10),a.$on("$destroy",d.destroy)}}}}).directive("masonryBrick",function(){return{restrict:"AC",require:"^masonry",scope:!0,link:{pre:function(a,b,c,d){var e,f=a.$id;d.appendBrick(b,f),b.on("$destroy",function(){d.removeBrick(f)}),a.$watch("$index",function(){void 0!==e&&e!==a.$index&&d.scheduleMasonry(),e=a.$index})}}}})}(),function(){angular.module("braind").directive("bdModal",["$window","$rootScope",function(a,b){return{restrict:"C",scope:{},link:{pre:function(c,d){var e=function(){d.css("display","none"),angular.element(".bd-backdrop").css("display","none"),angular.element("body").removeClass("modal-open")},f=function(a){a.target===a.currentTarget&&(a.preventDefault(),a.stopPropagation(),e())};d.bind("click",f);var g=function(){var b=d.find(".height-limit"),c=angular.element(a).height();b.css("max-height",c-.02*c-100+"px")};b.$on("bd:mopen",function(){g(),d.css("display","block"),angular.element(".bd-backdrop").css("display","block"),angular.element("body").addClass("modal-open")}),b.$on("bd:mclose",function(){e()}),angular.element(a).bind("resize",g),d.on("$destroy",function(){angular.element(a).unbind("resize",g),d.unbind("click",f)})}}}}])}(),angular.module("bdFilters",[]).filter("bdToArray",function(){return function(a){var b;return a instanceof Object?Object.keys(a).map(function(c){return b=Object.create(null),b.value=c,Object.defineProperty(a[c],"$key",b)}):a}}).filter("bdCut",function(){return function(a,b,c,d){if(!a)return"";if(c=parseInt(c,10),!c)return a;if(a.length<=c)return a;if(a=a.substr(0,c),b){var e=a.lastIndexOf(" ");-1!==e&&(a=a.substr(0,e))}return a+(d||" …")}});