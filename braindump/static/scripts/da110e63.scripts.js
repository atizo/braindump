"use strict";angular.module("braind",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ngTouch","restangular","monospaced.elastic","ui.bootstrap.modal","ui.bootstrap.transition","angularFileUpload","bdDirectives","bdFilters"]).config(["$routeProvider","$locationProvider","$httpProvider","$provide","bdClipProvider",function(a,b,c,d,e){b.html5Mode(!0),c.defaults.xsrfHeaderName="X-CSRFToken",c.defaults.xsrfCookieName="csrftoken",a.when("/",{templateUrl:"/static/views/main.html",controller:"StartCtrl"}).when("/glitch",{templateUrl:"/static/views/glitch.html",controller:"GlitchCtrl"}).when("/:brainstorming/invite",{templateUrl:"/static/views/invite.html",controller:"InviteCtrl"}).when("/:brainstorming/edit",{templateUrl:"/static/views/edit.html",controller:"EditCtrl"}).when("/:brainstorming/notification",{templateUrl:"/static/views/notification.html",controller:"NotificationCtrl"}).when("/:brainstorming",{templateUrl:"/static/views/brainstorming.html",controller:"BrainstormingCtrl"}).otherwise({redirectTo:"/"}),e.setPath("/static/bower_components/zeroclipboard/ZeroClipboard.swf"),d.constant("brainstormingStore",angular.copy(window.brainstormingStore)),d.constant("ideaStore",angular.copy(window.ideaStore)),d.constant("recentBrainstormings",angular.copy(window.recentBrainstormings)),d.constant("errorMsg",angular.copy(window.errorMsg)),d.constant("infoMsg",angular.copy(window.infoMsg))}]).run(["$rootScope","$location","errorMsg",function(a,b,c){c&&c.length>0&&b.path("/glitch").replace(),a.user={email:angular.copy(window.email),name:angular.copy(window.name)}}]),angular.module("braind").controller("StartCtrl",["$scope","$rootScope","$location","brainstormingService",function(a,b,c,d){b.showDeco=!1,a.create=function(){a.user.email=a.formData.creatorEmail,a.loading=!0,d.post(a.formData).then(function(a){c.path("/"+a.id+"/invite")})["finally"](function(){a.loading=!1})},a.reset=function(){a.formData={question:"",creatorEmail:a.user.email,details:""}},a.showDeco=!0,d.getRecent().then(function(c){a.rb=c,b.showDeco=!c.length}),a.reset()}]),angular.module("braind").controller("InviteCtrl",["$scope","$rootScope","$location","$routeParams","brainstormingService",function(a,b,c,d,e){var f=e.get(d.brainstorming);f.then(function(b){a.bs=b,a.subject=window.encodeURIComponent(a.bs.question),a.body=window.encodeURIComponent('I would like to invite you to the brainstorming "'+a.bs.question+'"\n\nPlease follow the link in order to participate in the brainstorming:\n'+a.bs.url)},function(){c.path("/").replace()})}]),angular.module("braind").controller("BrainstormingCtrl",["$scope","$routeParams","$location","$modal","$upload","brainstormingService","bdDate",function(a,b,c,d,e,f,g){var h=b.brainstorming;a.file=null,f.get(h).then(function(b){b.createdFormatted=g.format(b.created),a.brainstorming=b},function(){c.path("/").replace()}),f.getIdeas(h).then(function(b){a.ideasRaw=b}),a.$watchCollection("ideasRaw",function(b){b=_.toArray(b),_.each(b,function(a){a.createdDate=a.created?new Date(a.created):0}),a.ideas=_.sortBy(b,function(a){return-a.createdDate})}),a.create=function(){f.postIdea(h,a.formData,a.file).then(function(){a.user.name=a.formData.creatorName,a.reset(),a.fullform=!1})},a.openDetail=function(b){var c=a.$new();c.idea=b,d.open({templateUrl:"/static/views/idea-modal.html",controller:"IdeaDetailCtrl",scope:c,animate:!1})},a.toolBar=[{href:"/"+h+"/notification","class":"icon-star",title:"Notifcations"},{href:"/"+h+"/edit","class":"icon-pencil",title:"Edit"}],a.reset=function(){a.formData={title:"",text:"",creatorName:a.user.name}},a.reset()}]).controller("IdeaDetailCtrl",["$scope","$modalInstance","$window","$timeout","brainstormingService",function(a,b,c,d,e){a.editMode=!1,a.close=function(){b.close()},a.rate=function(){a.idea.canEdit||e.rateIdea(a.idea.brainstorming,a.idea.id)},a.deleteIdea=function(){c.confirm("Do you really want to delete this idea?")&&(e.deleteIdea(a.idea.brainstorming,a.idea.id),b.close())},a.startEdit=function(){var b=angular.element(c.document);a.formData=_.clone(a.idea),a.editMode=!0,d(function(){a.formData.title?b.find(".modal form .title").focus():a.formData.text&&b.find(".modal form .text").focus()},0)},a.cancelEdit=function(){a.editMode=!1},a.saveEdit=function(){e.updateIdea(a.idea.brainstorming,a.idea.id,a.formData).then(function(){a.user.name=a.formData.creatorName,a.editMode=!1})}}]),angular.module("braind").controller("NotificationCtrl",["$scope","$rootScope","$location","$routeParams","brainstormingService","messageService",function(a,b,c,d,e,f){var g=e.get(d.brainstorming),h=f.getMsg();a.nuser={email:""},g.then(function(b){a.bs=b,h.length>0?a.infoMsg=h:a.submit=function(){b.post("notification",a.nuser).then(function(b){a.status={email:a.nuser.email,action:b.status}})}},function(){c.path("/").replace()})}]),angular.module("braind").controller("EditCtrl",["$scope","$rootScope","$location","$routeParams","brainstormingService",function(a,b,c,d,e){var f=e.get(d.brainstorming);a.nuser={email:""},f.then(function(b){a.bs=b,b.canEdit?(a.formData={question:b.question,details:b.details},a.update=function(){e.update(b.id,a.formData).then(function(){c.path("/"+b.id)})}):a.submit=function(){b.post("edit",a.nuser).then(function(b){a.status={email:a.nuser.email,action:b.status}})}},function(){c.path("/").replace()})}]),angular.module("braind").controller("GlitchCtrl",["$scope","errorMsg",function(a,b){a.errorMsg=b}]),angular.module("braind").factory("brainstormingService",["Restangular","$q","$upload","brainstormingStore","ideaStore","recentBrainstormings",function(a,b,c,d,e,f){function g(a){return l+"/"+a+"/ideas"}function h(a){return f=_.without(f,a),f.unshift(a),f}function i(a,b){return _.has(e,a)||(e[a]={}),e[a][b.id]=b,b}function j(a,b){return _.has(e,a)||(e[a]={}),_.has(e[a],b.id)||(e[a][b.id]={}),_.merge(e[a][b.id],b),b}function k(a,b){_.has(e,a)&&delete e[a][b]}var l="api/brainstormings";_.forOwn(d,function(b,c){d[c]=a.restangularizeElement(null,b,l)}),_.forOwn(e,function(b,c){_.forOwn(b,function(b,d){e[c][d]=a.restangularizeElement(null,b,g(c))})});var m={};return m.get=function(c){return _.has(d,c)?(h(c),b.when(d[c])):a.one(l,c).get().then(function(a){return h(a.id),d[a.id]=a,a})},m.getRecent=function(){var a,c=10,d=[];return _(f).forEach(function(b){return a>c?!1:(d.push(m.get(b)),void(a+=1))}),b.all(d)},m.post=function(b){return a.all(l).post(b).then(function(a){return h(a.id),d[a.id]=a,a})},m.update=function(a,b){return m.get(a).then(function(a){return a.patch(b).then(function(a){return h(a.id),d[a.id]=a,a})})},m.getIdeas=function(c){return _.has(e,c)?b.when(e[c]):a.all(g(c)).getList().then(function(a){return e[c]={},_(a).forEach(function(a){e[c][a.id]=a}),e[c]})},m.getIdea=function(c,d){return _.has(e,c)&&_.has(e[c],d)?b.when(e[c][d]):a.one(g(c),d).get().then(function(a){return i(c,a)})},m.postIdea=function(b,d,e){return e?c.upload({url:g(b),data:d,file:e,fileFormDataName:"imagefile"}).then(function(c){return i(b,a.restangularizeElement(null,c.data,g(b)))}):a.all(g(b)).post(d).then(function(a){return i(b,a)})},m.updateIdea=function(b,d,e,f){return f?c.upload({url:g(b)+"/"+d,data:e,file:f,method:"PUT",fileFormDataName:"imagefile"}).then(function(c){return i(b,a.restangularizeElement(null,c.data,g(b)))}):a.one(g(b),d).patch(e).then(function(a){return j(b,a)})},m.deleteIdea=function(b,c){return a.one(g(b),c).remove().then(function(){return k(b,c)})},m.rateIdea=function(b,c){return _.has(e,b)&&_.has(e[b],c)&&(e[b][c].ratings||(e[b][c].ratings=0),e[b][c].rated?(e[b][c].rated=!1,e[b][c].ratings=e[b][c].ratings-=1):(e[b][c].rated=!0,e[b][c].ratings=e[b][c].ratings+=1)),a.one(g(b),c).post("rate").then(function(a){return j(b,a)})},m}]),angular.module("braind").factory("bdDate",["$window",function(a){var b={};return b.formatFromNow=function(b){var c,d,e=null,f=null,g=new Date;return angular.isDate(b)||(b=new Date(b)),c=a.moment(b),d=Math.abs(a.moment().diff(c,"minute")),1320>d?(1>d?e=1:50>d?e=30:1320>d&&(e=300),f=c.fromNow()):f=c.format(c.year()===g.getFullYear()?"D. MMM HH:mm":"D. MMM YYYY HH:mm"),{fromNow:f,secondsUntilUpdate:e}},b.format=function(b,c){angular.isDate(b)||(b=new Date(b)),angular.isDefined(c)||(c="D. MMM YYYY HH:mm");var d=a.moment(b);return angular.isDefined(c)?d.format(c):d.toString()},b}]),angular.module("braind").factory("messageService",["infoMsg",function(a){var b=!0;return{getMsg:function(){return b?(b=!1,a):""}}}]),angular.module("braind").directive("bdFromNow",["$timeout","bdDate",function(a,b){return{restrict:"E",link:function(c,d,e){function f(c){var e=b.formatFromNow(c);d.text(e.fromNow),angular.isDefined(e.secondsUntilUpdate)&&(h=a(function(){f(c)},1e3*e.secondsUntilUpdate,!1))}function g(){h&&(a.cancel(h),h=null)}var h=null;c.$watch(e.value,function(a){g(),angular.isDefined(a)&&null!==a&&f(a)}),c.$on("destroy",g)}}}]),angular.module("bdDirectives",[]).provider("bdClip",function(){var a=this;return this.path="//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.2.3/ZeroClipboard.swf",{setPath:function(b){a.path=b},$get:function(){return{path:a.path}}}}).run(["$document","bdClip",function(a,b){ZeroClipboard.config({moviePath:b.path,trustedDomains:["*"],allowScriptAccess:"always",forceHandCursor:!0})}]).directive("bdClipCopy",[function(){return{scope:{bdClipCopy:"&",bdClipClick:"&"},restrict:"A",link:function(a,b,c){var d=new ZeroClipboard(b);d.on("load",function(d){var e=function(b){b.setText(a.$eval(a.bdClipCopy)),angular.isDefined(c.bdClipClick)&&a.$apply(a.bdClipClick)};d.on("mousedown",e),a.$on("$destroy",function(){d.off("mousedown",e),d.unclip(b)})})}}}]),angular.module("braind").directive("bdHeader",[function(){return{restrict:"EA",templateUrl:"/static/views/directives/bdheader.html",scope:{title:"@",action:"&",tools:"=",href:"@"}}}]),angular.module("braind").directive("bdIdea",["brainstormingService",function(a){return{restrict:"C",templateUrl:"/static/views/directives/bdidea.html",scope:{resource:"=",limitText:"@",dynamicTextSize:"@",hideRatings:"@"},link:function(b){var c=null;b.dynamicTextSize?(c=b.$watchCollection("[resource.title, resource.text]",function(){var a=b.resource.title.length+b.resource.text.length;b.sizeClass=25>=a?"size-5":50>=a?"size-4":150>=a?"size-3":300>=a?"size-2":"size-1"}),b.$on("$destroy",c)):b.sizeClass="",b.rate=function(c){c.stopPropagation(),b.resource.canEdit||a.rateIdea(b.resource.brainstorming,b.resource.id)}}}}]),angular.module("braind").directive("bdUpload",["$parse",function(a){var b=function(a,b){var c=new Image;c.onload=function(){b(c)},c.src=a};return{restrict:"A",replace:!0,require:"ngModel",templateUrl:"/static/views/directives/image.html",priority:100,link:function(c,d,e,f){function g(){c.$apply(function(){h.$setViewValue(""),h.$setValidity("",!1),c.showPreview=!1,c.error="Invalid image (max. 3MB)"})}var h=f,i=d.find("input"),j=d.find("img"),k=new FileReader,l=a(e.showInitialSrc)(c),m=a(e.ngModel)(c);h.$name="image",l&&m&&(j.attr("src",m),c.showPreview=!0),c.clear=function(){h.$setViewValue(""),c.showPreview=!1},i.bind("change",function(d){var f=d.target.files[0];k.onload=function(d){try{b(d.target.result,angular.noop),j.attr("src",d.target.result),c.$apply(function(){h.$setViewValue(d.target.result),a(e.file).assign(c,f),c.showPreview=!0,c.error=""})}catch(i){g()}},!f.type.match(/image.*/)||f.size>3145728?g():k.readAsDataURL(f)})}}}]),function(){angular.module("braind").controller("MasonryCtrl",["$scope","$element","$timeout","$window",function(a,b,c,d){var e={},f=!1,g=!1,h=this,i=null;this.minColumnWidth=220,this.gap=15,this.scheduleMasonry=function(){i&&c.cancel(i),i=c(h.runMasonry,30)},this.runMasonry=function(){var a,d=Math.floor(b.width()/(h.minColumnWidth+h.gap))||1,f=Math.floor((b.width()-(d-1)*h.gap)/d),g=null,i=null;g=Array.apply(null,new Array(d)).map(Number.prototype.valueOf,0),a=_.toArray(e).sort(function(a,b){return a.scope().$index-b.scope().$index}),_.forOwn(a,function(a){a.css("width",f+"px")});var j=function(){_.forOwn(a,function(a){var b=a.outerHeight(!0);i=g.indexOf(Math.min.apply(Math,g)),a.css("transform","translate("+(i*f+i*h.gap)+"px, "+g[i]+"px)"),b>=417?a.addClass("limited"):a.removeClass("limited"),g[i]+=b+h.gap,a.addClass("show")}),b.css("height",Math.max.apply(Math,g)+"px")};c(j,10)},this.appendBrick=function(a,b){g||(void 0===e[b]&&(e[b]=a),h.scheduleMasonry(),f||(f=!0,angular.element(d).load(h.scheduleMasonry)))},this.removeBrick=function(a){g||(delete e[a],h.scheduleMasonry())},this.destroy=function(){g=!0,angular.element(d).unbind("resize",h.scheduleMasonry),angular.element(d).unbind("load",h.scheduleMasonry),a.$emit("masonry.destroyed"),e=[]},angular.element(d).bind("resize",h.scheduleMasonry)}]).directive("masonry",function(){return{restrict:"AE",controller:"MasonryCtrl",link:{pre:function(a,b,c,d){d.minColumnWidth=parseInt(c.minColumnWidth,10),d.gap=parseInt(c.gap,10),a.$on("$destroy",d.destroy)}}}}).directive("masonryBrick",function(){return{restrict:"AC",require:"^masonry",scope:!0,link:{pre:function(a,b,c,d){var e,f=a.$id;d.appendBrick(b,f),b.on("$destroy",function(){d.removeBrick(f)}),a.$watch("$index",function(){void 0!==e&&e!==a.$index&&d.scheduleMasonry(),e=a.$index})}}}})}(),angular.module("bdFilters",[]).filter("bdToArray",function(){return function(a){var b;return a instanceof Object?Object.keys(a).map(function(c){return b=Object.create(null),b.value=c,Object.defineProperty(a[c],"$key",b)}):a}}).filter("bdCut",function(){return function(a,b,c,d){if(!a)return"";if(c=parseInt(c,10),!c)return a;if(a.length<=c)return a;if(a=a.substr(0,c),b){var e=a.lastIndexOf(" ");-1!==e&&(a=a.substr(0,e))}return a+(d||" …")}}),function(){angular.module("ui.bootstrap.modal",["ui.bootstrap.transition"]).factory("$$stackedMap",function(){return{createNew:function(){var a=[];return{add:function(b,c){a.push({key:b,value:c})},get:function(b){for(var c=0;c<a.length;c++)if(b==a[c].key)return a[c]},keys:function(){for(var b=[],c=0;c<a.length;c++)b.push(a[c].key);return b},top:function(){return a[a.length-1]},remove:function(b){for(var c=-1,d=0;d<a.length;d++)if(b==a[d].key){c=d;break}return a.splice(c,1)[0]},removeTop:function(){return a.splice(a.length-1,1)[0]},length:function(){return a.length}}}}}).directive("modalBackdrop",["$timeout",function(a){return{restrict:"EA",replace:!0,templateUrl:"/static/views/bootstrap/modal/backdrop.html",link:function(b){b.animate=!1,a(function(){b.animate=!0})}}}]).directive("modalWindow",["$modalStack","$timeout",function(a,b){return{restrict:"EA",scope:{index:"@",animate:"="},replace:!0,transclude:!0,templateUrl:"/static/views/bootstrap/modal/window.html",link:function(c,d,e){c.windowClass=e.windowClass||"",b(function(){c.animate=!0,d[0].focus()}),c.close=function(b){var c=a.getTop();c&&c.value.backdrop&&"static"!=c.value.backdrop&&b.target===b.currentTarget&&(b.preventDefault(),b.stopPropagation(),a.dismiss(c.key,"backdrop click"))}}}}]).factory("$modalStack",["$transition","$timeout","$document","$compile","$rootScope","$$stackedMap",function(a,b,c,d,e,f){function g(){for(var a=-1,b=n.keys(),c=0;c<b.length;c++)n.get(b[c]).value.backdrop&&(a=c);return a}function h(a){var b=c.find("body").eq(0),d=n.get(a).value;n.remove(a),j(d.modalDomEl,d.modalScope,300,function(){d.modalScope.$destroy(),b.toggleClass(m,n.length()>0),i()})}function i(){if(k&&-1==g()){var a=l;j(k,l,150,function(){a.$destroy(),a=null}),k=void 0,l=void 0}}function j(c,d,e,f){function g(){g.done||(g.done=!0,c.remove(),f&&f())}d.animate=!1;var h=a.transitionEndEventName;if(h){var i=b(g,e);c.bind(h,function(){b.cancel(i),g(),d.$apply()})}else b(g,0)}var k,l,m="modal-open",n=f.createNew(),o={};return e.$watch(g,function(a){l&&(l.index=a)}),c.bind("keydown",function(a){var b;27===a.which&&(b=n.top(),b&&b.value.keyboard&&e.$apply(function(){o.dismiss(b.key)}))}),o.open=function(a,b){n.add(a,{deferred:b.deferred,modalScope:b.scope,backdrop:b.backdrop,keyboard:b.keyboard});var f=c.find("body").eq(0),h=g();h>=0&&!k&&(l=e.$new(!0),l.index=h,k=d("<div modal-backdrop></div>")(l),f.append(k));var i=angular.element("<div modal-window></div>");i.attr("window-class",b.windowClass),i.attr("index",n.length()-1),i.attr("animate","animate"),i.html(b.content);var j=d(i)(b.scope);n.top().value.modalDomEl=j,f.append(j),f.addClass(m)},o.close=function(a,b){var c=n.get(a).value;c&&(c.deferred.resolve(b),h(a))},o.dismiss=function(a,b){var c=n.get(a).value;c&&(c.deferred.reject(b),h(a))},o.dismissAll=function(a){for(var b=this.getTop();b;)this.dismiss(b.key,a),b=this.getTop()},o.getTop=function(){return n.top()},o}]).provider("$modal",function(){var a={options:{backdrop:!0,keyboard:!0},$get:["$injector","$rootScope","$q","$http","$templateCache","$controller","$modalStack",function(b,c,d,e,f,g,h){function i(a){return a.template?d.when(a.template):e.get(a.templateUrl,{cache:f}).then(function(a){return a.data})}function j(a){var c=[];return angular.forEach(a,function(a){(angular.isFunction(a)||angular.isArray(a))&&c.push(d.when(b.invoke(a)))}),c}var k={};return k.open=function(b){var e=d.defer(),f=d.defer(),k={result:e.promise,opened:f.promise,close:function(a){h.close(k,a)},dismiss:function(a){h.dismiss(k,a)}};if(b=angular.extend({},a.options,b),b.resolve=b.resolve||{},!b.template&&!b.templateUrl)throw new Error("One of template or templateUrl options is required.");var l=d.all([i(b)].concat(j(b.resolve)));return l.then(function(a){var d=(b.scope||c).$new();d.$close=k.close,d.$dismiss=k.dismiss;var f,i={},j=1;b.controller&&(i.$scope=d,i.$modalInstance=k,angular.forEach(b.resolve,function(b,c){i[c]=a[j++]}),f=g(b.controller,i)),h.open(k,{scope:d,deferred:e,content:a[0],backdrop:b.backdrop,keyboard:b.keyboard,windowClass:b.windowClass})},function(a){e.reject(a)}),l.then(function(){f.resolve(!0)},function(){f.reject(!1)}),k},k}]};return a})}(),function(){angular.module("ui.bootstrap.transition",[]).factory("$transition",["$q","$timeout","$rootScope",function(a,b,c){function d(a){for(var b in a)if(void 0!==f.style[b])return a[b]}var e=function(d,f,g){g=g||{};var h=a.defer(),i=e[g.animation?"animationEndEventName":"transitionEndEventName"],j=function(){c.$apply(function(){d.unbind(i,j),h.resolve(d)})};return i&&d.bind(i,j),b(function(){angular.isString(f)?d.addClass(f):angular.isFunction(f)?f(d):angular.isObject(f)&&d.css(f),i||h.resolve(d)}),h.promise.cancel=function(){i&&d.unbind(i,j),h.reject("Transition cancelled")},h.promise},f=document.createElement("trans"),g={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",transition:"transitionend"},h={WebkitTransition:"webkitAnimationEnd",MozTransition:"animationend",OTransition:"oAnimationEnd",transition:"animationend"};return e.transitionEndEventName=d(g),e.animationEndEventName=d(h),e}])}();